@using ODK.Umbraco.Events;
@using ODK.Umbraco.Members;
@inherits ODK.Umbraco.Web.Mvc.OdkUmbracoTemplatePage
@{
    Layout = "Master.cshtml";

    string redirectUrl = Model.Content.GetPropertyValue<string>("redirectUrl");
    if (!string.IsNullOrWhiteSpace(redirectUrl) && Model.Content.GetPropertyValue<bool>("redirectEnabled"))
    {
        Response.Redirect(redirectUrl);
    }
}

<div class="container">
    <div class="row">
        <div class="col-lg-9 col-md-8 order-2 order-md-1">
            @Html.Partial("Content")

            @RenderLatestMembers()
            @RenderInstagramFeed()
        </div>

        <div class="col-lg-3 col-md-4 order-1 order-md-2">
            <div class="sidebar">
                @RenderUpcomingEvents()
            </div>
        </div>
    </div>
</div>

@helper RenderUpcomingEvents()
{
    IPublishedContent member = CurrentMember;
    IPublishedContent eventsPage = Model.Content.GetPropertyValue<IPublishedContent>("eventsPage");
    EventService eventService = new EventService(eventsPage, member);

    int maxItems = Model.Content.GetPropertyValue<int>("numberOfNextEvents");
    if (maxItems <= 0)
    {
        maxItems = 3;
    }

    EventSearchCriteria criteria = new EventSearchCriteria
    {
        FutureOnly = true,
        MaxItems = 3
    };

    EventModel[] nextEvents = eventService.SearchEvents(criteria).OrderBy(x => x.Date).ToArray();
    if (nextEvents.Length == 0)
    {
        return;
    }

    <div class="card">
        <div class="card-header">
            Upcoming events
        </div>
        <div class="card-body events">
            @foreach (EventModel ev in nextEvents)
            {
                <div class="event">
                    <h5 class="card-title"><a href="@ev.Url">@ev.Name</a></h5>
                    <h6>@ev.Date.ToString("dd MMMM yyyy")</h6>
                    <div>@ev.Location</div>
                </div>
            }
        </div>
    </div>
}

@helper RenderInstagramFeed()
{
    string username = Model.Content.GetPropertyValue<string>("instagramUsername");
    if (string.IsNullOrEmpty(username))
    {
        return;
    }

    int maxItems = Model.Content.GetPropertyValue<int>("instagramMaxItems");
    if (maxItems <= 0)
    {
        maxItems = 8;
    }

    <div class="content">
        <h3>Latest Instagram Photos</h3>
        <div class="feed--instagram row" data-instagram-username="@username" data-instagram-maxitems="@maxItems">

        </div>
        <p class="text-right">
            <i class="fab fa-instagram"></i>&nbsp;<a href="https://instagram.com/@username" target="_blank">@username</a>
        </p>
    </div>

    <div class="d-none media-template--instagram">
        <div class="media-item col-3">
            <a target="_blank"><img class="media-item__image" /></a>
        </div>
    </div>
}

@helper RenderLatestMembers()
{
    int maxItems = Model.Content.GetPropertyValue<int>("numberOfLatestMembers");
    if (maxItems <= 0)
    {
        maxItems = 8;
    }

    MemberModel[] members = MemberService.GetMembers(new MemberSearchCriteria(Model.Content.Id)
    {
        MaxItems = maxItems,
        Sort = m => m.OrderByDescending(x => x.Joined)
    }, Umbraco).ToArray();

    if (members.Length == 0)
    {
        return;
    }

    <div class="content">
        <h3>Latest members</h3>
        <div class="row">
            @foreach (MemberModel member in members)
            {
                <div class="col-lg-3 col-6">
                    @Html.Partial("PersonThumbnail", ModelFor<MemberModel>(member))
                </div>
            }
        </div>
    </div>
}