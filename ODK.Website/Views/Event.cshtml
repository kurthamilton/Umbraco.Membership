@using ODK.Umbraco.Events;
@inherits ODK.Umbraco.Web.Mvc.OdkUmbracoTemplatePage
@{
    Layout = "Master.cshtml";

    EventModel eventModel = new EventModel(Model.Content);

    bool restricted = CurrentMember == null && !eventModel.Public;
    if (restricted)
    {
        Response.Redirect(Model.Content.Parent.Url);
        return;
    }

    string mapApiKey = Model.Content.Site().GetPropertyValue<string>("googleMapsApiKey");
    string mapUrl = !string.IsNullOrEmpty(eventModel.MapQuery) ? "https://www.google.com/maps/embed/v1/place?key=" + mapApiKey + "&q=" + eventModel.MapQuery : null;

    IPublishedContent[] paymentOptions = Model.Content.Children.ToArray();
    string paypalButtonId = HomePage.GetPropertyValue<string>("payPalEventsButtonId");
}
<section class="section section--main">
    <div class="container">
        <div class="row">
            <div class="col-lg-9 col-md-8">
                <h2>@eventModel.Location</h2>
                <h2>@eventModel.Date.ToString("dd MMMM yyyy")</h2>
                <p>
                    <a class="d-md-none" href="#map">@eventModel.Address</a>
                    <span class="d-none d-md-inline">@eventModel.Address</span>
                </p>

                @if (paymentOptions.Length > 0)
                {
                    <div>
                        @foreach (IPublishedContent paymentOption in paymentOptions)
                        {
                            string name = paymentOption.GetPropertyValue<string>("payPalMenuOptionName");
                            string title = paymentOption.GetPropertyValue<string>("payPalOptionTitle");
                            bool allowQuantity = paymentOption.GetPropertyValue<bool>("payPalOptionAllowQuantity");
                            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
                                <input type="hidden" name="cmd" value="_s-xclick">
                                <input type="hidden" name="hosted_button_id" value="@paypalButtonId">
                                @*TODO - currency code variable*@
                                <input type="hidden" name="currency_code" value="GBP">
                                <input type="hidden" name="on0" value="Select an event">
                                <input type="hidden" name="os0" value="@name" />
                                <input type="hidden" name="custom" data-payment-token />

                                <span>@title</span>
                                @if (allowQuantity)
                                {
                                    <select>
                                        <option>0</option>
                                        <option>1</option>
                                        <option>2</option>
                                    </select>
                                }
                            </form>
                        }
                    </div>
                }

                @Html.Raw(eventModel.Description)

                <div class="d-none d-md-block">
                    @RenderMap(mapUrl)
                </div>
            </div>
            <div class="col-lg-3 col-md-4">
                <div class="sidebar" data-ajax-container>
                    @Html.Action("EventSidebar", "Events", new { eventId = Model.Content.Id })
                </div>
            </div>
            <div class="col-lg-9 col-md-8 d-md-none mt-5" id="map">
                @RenderMap(mapUrl)
            </div>
        </div>
    </div>
</section>

@helper RenderMap(string url)
{
    if (string.IsNullOrEmpty(url))
    {
        return;
    }

    <iframe width="100%" height="450" frameborder="0" style="border:0" src="@url" allowfullscreen></iframe>
}